/* VIết chương trình mô phỏng tay ga của xe đạp điện/máy điện/ôtô (dẫn động l banh -> điều khiển tốc độ động cơ theo thay đổi của chiết áp. hiển thị tốc độ tương đối lên GLCD/LCD (tùy chọn)
gợi ý: sử dụng chiết áp thay đổi giá trị điện áp ADC vào một kênh nào đó và thay dội giả tri PWM để điều khiển tốc độ động cơ)
/*
#include <io.h>
#include <delay.h>
#include <stdint.h>

#define ADC_PIN     0      //ADC0

int adc_value, pwm_value;


// Voltage Reference: AVCC pin
#define ADC_VREF_TYPE ((0<<REFS1) | (1<<REFS0) | (0<<ADLAR))
// Read the AD conversion result
unsigned int read_adc(unsigned char adc_input)
{

    ADMUX=adc_input | ADC_VREF_TYPE;
    // Delay needed for the stabilization of the ADC input voltage
    delay_us(10);
    // Start the AD conversion
    ADCSRA|=(1<<ADSC);
    // Wait for the AD conversion to complete
    while ((ADCSRA & (1<<ADIF))==0);
    ADCSRA|=(1<<ADIF);
    return ADCW;
}
void pwm_write(uint8_t pwm_value)
{     
    OCR1A=pwm_value;
}

void main(void)
{          
    //output pwm pin  
    DDRB.5=1;  
                
    //PWM initialization
    TCCR1A=(1<<COM1A1) | (1<<WGM10);
    TCCR1B=(1<<WGM12) | (1<<CS11);

    
    // ADC initialization
    // ADC Clock frequency: 1000.000 kHz
    // ADC Voltage Reference: AVCC pin
    ADMUX=ADC_VREF_TYPE;
    ADCSRA=(1<<ADEN) | (1<<ADPS1) | (1<<ADPS0);
    
    //loop
    while (1)
    {
        adc_value=read_adc(ADC_PIN);
        pwm_value=adc_value*255.0/1023.0;
        pwm_write(pwm_value);
        delay_ms(10);
    }
}